# Alertmanager é…ç½®
# ä¸šåŠ¡åˆ†ææŠ¥å‘Šè‡ªåŠ¨åŒ–ç³»ç»Ÿå‘Šè­¦ç®¡ç†

global:
  # SMTPé…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@your-company.com'
  smtp_auth_username: 'alerts@your-company.com'
  smtp_auth_password: 'your-email-password'
  smtp_require_tls: true

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  
  routes:
    # å…³é”®æœåŠ¡å‘Šè­¦ - ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      
    # å®‰å…¨ç›¸å…³å‘Šè­¦
    - match:
        service: security
      receiver: 'security-team'
      group_wait: 30s
      repeat_interval: 30m
      
    # æ•°æ®åº“å‘Šè­¦
    - match:
        service: database
      receiver: 'database-team'
      group_wait: 1m
      repeat_interval: 15m
      
    # åº”ç”¨ç¨‹åºå‘Šè­¦
    - match:
        service: analysis-app
      receiver: 'dev-team'
      group_wait: 2m
      repeat_interval: 30m

# å‘Šè­¦æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: 'team@your-company.com'
        subject: 'ğŸ“Š [{{ .Status | toUpper }}] ä¸šåŠ¡åˆ†æç³»ç»Ÿå‘Šè­¦'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # å…³é”®å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    # Slacké€šçŸ¥
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#critical-alerts'
        title: 'ğŸš¨ å…³é”®ç³»ç»Ÿå‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *æœåŠ¡*: {{ .Labels.service }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        actions:
          - type: button
            text: 'æŸ¥çœ‹è¯¦æƒ…'
            url: '{{ template "slack.default.callbackurl" . }}'
            
    # é‚®ä»¶é€šçŸ¥
    email_configs:
      - to: 'oncall@your-company.com'
        subject: 'ğŸš¨ [CRITICAL] ä¸šåŠ¡åˆ†æç³»ç»Ÿå…³é”®å‘Šè­¦'
        body: |
          å…³é”®å‘Šè­¦è§¦å‘ï¼Œè¯·ç«‹å³å¤„ç†ï¼
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          {{ end }}
          
          è¯·ç™»å½•ç›‘æ§é¢æ¿æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š
          http://localhost:3000/
          
    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    wechat_configs:
      - api_url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_WECHAT_KEY'
        message: |
          ğŸš¨ å…³é”®ç³»ç»Ÿå‘Šè­¦
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æœåŠ¡: {{ .Labels.service }}
          æ—¶é—´: {{ .StartsAt.Format "15:04:05" }}
          {{ end }}

  # å®‰å…¨å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'security-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#security-alerts'
        title: 'ğŸ”’ å®‰å…¨å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å®‰å…¨å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color: 'danger'
        
    email_configs:
      - to: 'security@your-company.com'
        subject: 'ğŸ”’ [SECURITY] å®‰å…¨å‘Šè­¦é€šçŸ¥'
        body: |
          æ£€æµ‹åˆ°å®‰å…¨ç›¸å…³å‘Šè­¦ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # æ•°æ®åº“å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'database-team'
    email_configs:
      - to: 'dba@your-company.com'
        subject: 'ğŸ—„ï¸ [DATABASE] æ•°æ®åº“å‘Šè­¦'
        body: |
          æ•°æ®åº“ç›¸å…³å‘Šè­¦ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“çŠ¶æ€ã€‚
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ•°æ®åº“: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # å¼€å‘å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'dev-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#dev-alerts'
        title: 'âš ï¸ åº”ç”¨å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *åº”ç”¨å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *æœåŠ¡*: {{ .Labels.service }}
          {{ end }}
        color: 'warning'

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡å®Œå…¨å®•æœºï¼ŒæŠ‘åˆ¶å…¶ä»–ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: 'ApplicationDown'
    target_match:
      service: 'analysis-app'
    equal: ['instance']
    
  # å¦‚æœæ•°æ®åº“å®•æœºï¼ŒæŠ‘åˆ¶åº”ç”¨ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: 'DatabaseDown'
    target_match:
      service: 'analysis-app'
    equal: ['instance']
    
  # å¦‚æœç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼ŒæŠ‘åˆ¶CPUå‘Šè­¦
  - source_match:
      alertname: 'HighSystemLoad'
    target_match:
      alertname: 'HighCPUUsage'
    equal: ['instance']

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'