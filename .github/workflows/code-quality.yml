name: Code Quality Check - ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

jobs:
  # ä»£ç è´¨é‡åˆ†æ
  quality-analysis:
    name: ğŸ“Š ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºSonarCloudåˆ†æ

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–å’Œè´¨é‡å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-docker.txt
        pip install flake8 black isort mypy bandit safety pylint radon

    - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥ (Black)
      run: |
        black --check --diff src/ tests/

    - name: ğŸ“‹ å¯¼å…¥æ’åºæ£€æŸ¥ (isort)
      run: |
        isort --check-only --diff src/ tests/

    - name: ğŸ” ä»£ç é£æ ¼æ£€æŸ¥ (flake8)
      run: |
        flake8 src/ tests/ --statistics --tee --output-file=flake8-report.txt

    - name: ğŸ—ï¸ ä»£ç å¤æ‚åº¦åˆ†æ (radon)
      run: |
        radon cc src/ --total-average --show-complexity
        radon mi src/ --show --multi

    - name: ğŸ”’ å®‰å…¨æ¼æ´æ£€æŸ¥ (bandit)
      run: |
        bandit -r src/ -f json -o bandit-report.json

    - name: ğŸ“Š ç±»å‹æ£€æŸ¥ (mypy)
      run: |
        mypy src/ --html-report mypy-report --txt-report mypy-txt-report

    - name: ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥ (safety)
      run: |
        safety check --json --output safety-report.json || true

    - name: ğŸ“ˆ ä»£ç è´¨é‡è¯„åˆ† (pylint)
      run: |
        pylint src/ --output-format=json --reports=y > pylint-report.json || true

    - name: ğŸ“Š SonarCloudä»£ç åˆ†æ
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: ğŸ“‹ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-reports
        path: |
          flake8-report.txt
          bandit-report.json
          mypy-report/
          mypy-txt-report/
          safety-report.json
          pylint-report.json

  # æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: ğŸ“š æ–‡æ¡£è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” æ£€æŸ¥READMEæ–‡ä»¶
      run: |
        if [ ! -f README.md ]; then
          echo "âŒ README.md æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        echo "âœ… README.md æ–‡ä»¶å­˜åœ¨"

    - name: ğŸ“ æ£€æŸ¥æ–‡æ¡£é“¾æ¥
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/mlc_config.json'

    - name: ğŸ“Š ç»Ÿè®¡æ–‡æ¡£è¦†ç›–ç‡
      run: |
        echo "ğŸ“Š æ–‡æ¡£ç»Ÿè®¡ï¼š"
        echo "Markdownæ–‡ä»¶æ•°é‡: $(find . -name "*.md" | wc -l)"
        echo "Pythonæ–‡ä»¶æ•°é‡: $(find src/ -name "*.py" | wc -l)"
        echo "æ–‡æ¡£å­—ç¬¦æ•°: $(find . -name "*.md" -exec cat {} \; | wc -c)"

  # ä¾èµ–æ£€æŸ¥
  dependency-check:
    name: ğŸ“¦ ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: ğŸ” æ£€æŸ¥è¿‡æ—¶ä¾èµ–
      run: |
        pip install pip-audit
        pip-audit --desc --output pip-audit-report.json --format json

    - name: ğŸ“Š ä¾èµ–è®¸å¯è¯æ£€æŸ¥
      run: |
        pip install pip-licenses
        pip-licenses --format json --output-file licenses-report.json

    - name: ğŸ“‹ ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: dependency-reports
        path: |
          pip-audit-report.json
          licenses-report.json

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements-docker.txt
        pip install pytest-benchmark memory-profiler

    - name: âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/performance/ --benchmark-json=benchmark-results.json

    - name: ğŸ“Š æ€§èƒ½å›å½’æ£€æŸ¥
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'pytest'
        output-file-path: benchmark-results.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
        comment-on-alert: true
        alert-threshold: '200%'
        fail-on-alert: true

  # ä»£ç è¦†ç›–ç‡æ£€æŸ¥
  coverage-check:
    name: ğŸ“ˆ ä»£ç è¦†ç›–ç‡æ£€æŸ¥
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements-docker.txt
        pip install coverage pytest-cov

    - name: ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        PYTHONPATH: ${{ github.workspace }}
      run: |
        coverage run -m pytest tests/
        coverage report --show-missing
        coverage html
        coverage xml

    - name: ğŸ“Š è¦†ç›–ç‡æ³¨é‡Š
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MINIMUM_GREEN: 80
        MINIMUM_ORANGE: 60

    - name: ğŸ“‹ ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/