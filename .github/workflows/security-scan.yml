name: Security Scan - å®‰å…¨æ‰«æ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 3 * * 1'

jobs:
  # ä»£ç å®‰å…¨æ‰«æ
  code-security:
    name: ğŸ”’ ä»£ç å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…å®‰å…¨å·¥å…·
      run: |
        pip install bandit safety semgrep

    - name: ğŸ” Banditå®‰å…¨æ‰«æ
      run: |
        bandit -r src/ -f json -o bandit-security-report.json
        bandit -r src/ -f txt -o bandit-security-report.txt

    - name: ğŸ” ä¾èµ–æ¼æ´æ‰«æ (Safety)
      run: |
        pip install -r requirements-docker.txt
        safety check --json --output safety-vulnerabilities.json

    - name: ğŸ›¡ï¸ Semgrepä»£ç æ‰«æ
      run: |
        semgrep --config=auto src/ --json --output=semgrep-results.json

    - name: ğŸ“Š ä¸Šä¼ å®‰å…¨æŠ¥å‘Šåˆ°GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: semgrep-results.json

    - name: ğŸ“‹ ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-security-report.json
          bandit-security-report.txt
          safety-vulnerabilities.json
          semgrep-results.json

  # Dockeré•œåƒå®‰å…¨æ‰«æ
  container-security:
    name: ğŸ³ å®¹å™¨å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ æ„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        tags: analysis-report-system:security-scan
        load: true

    - name: ğŸ” Trivyæ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'analysis-report-system:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“Š ä¸Šä¼ Trivyç»“æœåˆ°GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ” Snykå®¹å™¨æ‰«æ
      uses: snyk/actions/docker@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        image: analysis-report-system:security-scan
        args: --file=Dockerfile --severity-threshold=high
      continue-on-error: true

    - name: ğŸ“‹ ä¸Šä¼ Snykç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: snyk.sarif

  # å¯†é’¥æ³„éœ²æ£€æŸ¥
  secret-scan:
    name: ğŸ”‘ å¯†é’¥æ³„éœ²æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” GitLeakså¯†é’¥æ‰«æ
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    - name: ğŸ” TruffleHogå¯†é’¥æ‰«æ
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # è®¸å¯è¯åˆè§„æ£€æŸ¥
  license-compliance:
    name: ğŸ“œ è®¸å¯è¯åˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements-docker.txt
        pip install pip-licenses licensecheck

    - name: ğŸ“œ æ£€æŸ¥PythonåŒ…è®¸å¯è¯
      run: |
        pip-licenses --format json --output-file python-licenses.json
        pip-licenses --format csv --output-file python-licenses.csv

    - name: ğŸ” è®¸å¯è¯å…¼å®¹æ€§æ£€æŸ¥
      run: |
        licensecheck --zero --ignore 'venv/**' --ignore '.git/**' . > license-check-results.txt

    - name: ğŸ“‹ ä¸Šä¼ è®¸å¯è¯æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: license-reports
        path: |
          python-licenses.json
          python-licenses.csv
          license-check-results.txt

  # OWASPä¾èµ–æ£€æŸ¥
  owasp-dependency-check:
    name: ğŸ›¡ï¸ OWASPä¾èµ–æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” OWASPä¾èµ–æ£€æŸ¥
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'analysis-report-system'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --failOnCVSS 7

    - name: ğŸ“Š ä¸Šä¼ OWASPæŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: owasp-reports
        path: reports/

  # å®‰å…¨é…ç½®æ£€æŸ¥
  security-config:
    name: âš™ï¸ å®‰å…¨é…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ•æ„Ÿæ–‡ä»¶..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥
        if grep -r "password\|secret\|key\|token" --include="*.py" --include="*.yml" --include="*.yaml" src/; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç å¯†é’¥"
        fi
        
        # æ£€æŸ¥Dockeré…ç½®å®‰å…¨æ€§
        if [ -f "Dockerfile" ]; then
          echo "ğŸ³ æ£€æŸ¥Dockerfileå®‰å…¨é…ç½®..."
          if grep -q "USER root" Dockerfile; then
            echo "âš ï¸ Dockerfileä½¿ç”¨rootç”¨æˆ·è¿è¡Œ"
          fi
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•ä¿¡æ¯æ³„éœ²
        if grep -r "DEBUG.*=.*True" --include="*.py" src/; then
          echo "âš ï¸ å‘ç°Debugæ¨¡å¼å¼€å¯"
        fi

    - name: ğŸ“‹ ç”Ÿæˆå®‰å…¨é…ç½®æŠ¥å‘Š
      run: |
        echo "# å®‰å…¨é…ç½®æ£€æŸ¥æŠ¥å‘Š" > security-config-report.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> security-config-report.md
        echo "" >> security-config-report.md
        echo "## æ£€æŸ¥é¡¹ç›®" >> security-config-report.md
        echo "- [x] æ•æ„Ÿæ–‡ä»¶æ£€æŸ¥" >> security-config-report.md
        echo "- [x] Dockerå®‰å…¨é…ç½®" >> security-config-report.md
        echo "- [x] è°ƒè¯•ä¿¡æ¯æ³„éœ²æ£€æŸ¥" >> security-config-report.md

    - name: ğŸ“‹ ä¸Šä¼ é…ç½®æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-config-report
        path: security-config-report.md

  # ç»¼åˆå®‰å…¨æŠ¥å‘Š
  security-summary:
    name: ğŸ“Š å®‰å…¨æ‰«ææ±‡æ€»
    runs-on: ubuntu-latest
    needs: [code-security, container-security, secret-scan, license-compliance, owasp-dependency-check, security-config]
    if: always()

    steps:
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰å®‰å…¨æŠ¥å‘Š
      uses: actions/download-artifact@v3

    - name: ğŸ“Š ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š
      run: |
        echo "# ğŸ”’ å®‰å…¨æ‰«æç»¼åˆæŠ¥å‘Š" > SECURITY_REPORT.md
        echo "" >> SECURITY_REPORT.md
        echo "**æ‰«ææ—¶é—´**: $(date)" >> SECURITY_REPORT.md
        echo "**æäº¤**: ${{ github.sha }}" >> SECURITY_REPORT.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> SECURITY_REPORT.md
        echo "" >> SECURITY_REPORT.md
        
        echo "## ğŸ“‹ æ‰«æç»“æœæ‘˜è¦" >> SECURITY_REPORT.md
        echo "" >> SECURITY_REPORT.md
        echo "| æ‰«æç±»å‹ | çŠ¶æ€ | è¯´æ˜ |" >> SECURITY_REPORT.md
        echo "|---------|------|------|" >> SECURITY_REPORT.md
        echo "| ğŸ” ä»£ç å®‰å…¨æ‰«æ | ${{ needs.code-security.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | Bandit + Safety + Semgrep |" >> SECURITY_REPORT.md
        echo "| ğŸ³ å®¹å™¨å®‰å…¨æ‰«æ | ${{ needs.container-security.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | Trivy + Snyk |" >> SECURITY_REPORT.md
        echo "| ğŸ”‘ å¯†é’¥æ³„éœ²æ£€æŸ¥ | ${{ needs.secret-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | GitLeaks + TruffleHog |" >> SECURITY_REPORT.md
        echo "| ğŸ“œ è®¸å¯è¯åˆè§„ | ${{ needs.license-compliance.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | è®¸å¯è¯å…¼å®¹æ€§æ£€æŸ¥ |" >> SECURITY_REPORT.md
        echo "| ğŸ›¡ï¸ OWASPä¾èµ–æ£€æŸ¥ | ${{ needs.owasp-dependency-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | å·²çŸ¥æ¼æ´æ•°æ®åº“ |" >> SECURITY_REPORT.md
        echo "| âš™ï¸ å®‰å…¨é…ç½®æ£€æŸ¥ | ${{ needs.security-config.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | é…ç½®å®‰å…¨æ€§æ£€æŸ¥ |" >> SECURITY_REPORT.md
        
        echo "" >> SECURITY_REPORT.md
        echo "## ğŸ“ è¯¦ç»†æŠ¥å‘Š" >> SECURITY_REPORT.md
        echo "è¯¦ç»†çš„æ‰«æç»“æœè¯·æŸ¥çœ‹å„ä¸ªæ­¥éª¤çš„Artifactsã€‚" >> SECURITY_REPORT.md

    - name: ğŸ“‹ ä¸Šä¼ ç»¼åˆå®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-security-report
        path: SECURITY_REPORT.md

    - name: ğŸ“¢ å®‰å…¨æ‰«æé€šçŸ¥
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#security'
        text: 'ğŸš¨ å®‰å…¨æ‰«æå‘ç°é—®é¢˜ï¼è¯·åŠæ—¶å¤„ç†ã€‚'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}