name: Release - ç‰ˆæœ¬å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # å‡†å¤‡å‘å¸ƒ
  prepare-release:
    name: ğŸ¯ å‡†å¤‡å‘å¸ƒ
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ ç¡®å®šç‰ˆæœ¬å·
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ å‘å¸ƒç‰ˆæœ¬: $VERSION"

    - name: ğŸ“ ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        echo "ğŸ“ ç”Ÿæˆå˜æ›´æ—¥å¿—..."
        
        # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "changelog=é¦–æ¬¡å‘å¸ƒ" >> $GITHUB_OUTPUT
        else
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          CHANGELOG=$(git log --pretty=format:"- %s" ${PREVIOUS_TAG}..HEAD)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: prepare-release

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-docker.txt
        pip install pytest pytest-cov

    - name: ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html

    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: release
        name: release-coverage

  # æ„å»ºå‘å¸ƒé•œåƒ
  build-release-image:
    name: ğŸ³ æ„å»ºå‘å¸ƒé•œåƒ
    runs-on: ubuntu-latest
    needs: [prepare-release, build-and-test]

    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“ æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest

    - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€å‘å¸ƒé•œåƒ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          BUILD_VERSION=${{ needs.prepare-release.outputs.version }}
          BUILD_REVISION=${{ github.sha }}

    - name: ğŸ·ï¸ è¾“å‡ºé•œåƒä¿¡æ¯
      id: image
      run: |
        echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
        echo "ğŸ³ å‘å¸ƒé•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare-release.outputs.version }}"

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ å‘å¸ƒå‰å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build-release-image

    steps:
    - name: ğŸ” Trivyå®‰å…¨æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ needs.build-release-image.outputs.image }}:${{ needs.prepare-release.outputs.version }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“Š ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # åˆ›å»ºGitHub Release
  create-release:
    name: ğŸ“¦ åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-and-test, build-release-image, security-scan]

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-assets
        
        # å¤åˆ¶é‡è¦æ–‡ä»¶åˆ°å‘å¸ƒåŒ…
        cp README.md release-assets/
        cp DOCKER_DEPLOYMENT_GUIDE.md release-assets/
        cp docker-compose.yml release-assets/
        cp docker-compose.dev.yml release-assets/
        cp requirements-docker.txt release-assets/
        cp -r scripts/ release-assets/
        cp -r .github/ release-assets/
        
        # åˆ›å»ºéƒ¨ç½²åŒ…
        tar -czf release-assets/deployment-package.tar.gz \
          docker-compose.yml \
          docker-compose.dev.yml \
          scripts/ \
          nginx/ \
          monitoring/
        
        # åˆ›å»ºæºç åŒ…
        git archive --format=tar.gz --prefix=analysis-report-system-${{ needs.prepare-release.outputs.version }}/ \
          HEAD > release-assets/source-code.tar.gz

    - name: ğŸ‰ åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare-release.outputs.version }}
        name: ä¸šåŠ¡åˆ†ææŠ¥å‘Šè‡ªåŠ¨åŒ–ç³»ç»Ÿ ${{ needs.prepare-release.outputs.version }}
        body: |
          ## ğŸ‰ ç‰ˆæœ¬ ${{ needs.prepare-release.outputs.version }} å‘å¸ƒ
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          ${{ needs.prepare-release.outputs.changelog }}
          
          ### ğŸ³ Dockeré•œåƒ
          ```bash
          docker pull ${{ needs.build-release-image.outputs.image }}:${{ needs.prepare-release.outputs.version }}
          ```
          
          ### ğŸš€ å¿«é€Ÿéƒ¨ç½²
          ```bash
          # ä¸‹è½½éƒ¨ç½²åŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare-release.outputs.version }}/deployment-package.tar.gz
          tar -xzf deployment-package.tar.gz
          
          # å¯åŠ¨æœåŠ¡
          ./scripts/docker-build.sh start production
          ```
          
          ### ğŸ“Š ç³»ç»Ÿè¦æ±‚
          - Docker 20.10+
          - Docker Compose 2.0+
          - å†…å­˜: 4GB+
          - ç£ç›˜: 10GB+
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [ğŸ“š éƒ¨ç½²æŒ‡å—](https://github.com/${{ github.repository }}/blob/${{ needs.prepare-release.outputs.version }}/DOCKER_DEPLOYMENT_GUIDE.md)
          - [ğŸ³ Docker Hub](https://github.com/${{ github.repository }}/pkgs/container/analysis-report-system)
          - [ğŸ“– APIæ–‡æ¡£](https://your-domain.com/docs)
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/v1.0.0...${{ needs.prepare-release.outputs.version }}
        files: |
          release-assets/*
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        draft: false

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    environment: production
    if: ${{ !github.event.inputs.prerelease }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®éƒ¨ç½²ç¯å¢ƒ
      run: |
        echo "ğŸ”§ é…ç½®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        # è¿™é‡Œæ·»åŠ å®é™…çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€»è¾‘
        # ä¾‹å¦‚: kubectl, helm, terraformç­‰

    - name: ğŸš€ æ‰§è¡Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
      run: |
        echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        echo "ç‰ˆæœ¬: ${{ needs.prepare-release.outputs.version }}"
        echo "é•œåƒ: ${{ needs.build-release-image.outputs.image }}:${{ needs.prepare-release.outputs.version }}"
        
        # å®é™…éƒ¨ç½²å‘½ä»¤
        # kubectl set image deployment/analysis-app app=${{ needs.build-release-image.outputs.image }}:${{ needs.prepare-release.outputs.version }}
        # kubectl rollout status deployment/analysis-app
        
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"

    - name: ğŸ§ª ç”Ÿäº§ç¯å¢ƒéªŒè¯
      run: |
        echo "ğŸ§ª éªŒè¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        # curl -f https://your-domain.com/api/info
        
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯é€šè¿‡"

  # å‘å¸ƒé€šçŸ¥
  notify:
    name: ğŸ“¢ å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release, deploy-production]
    if: always()

    steps:
    - name: ğŸ“¢ Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#releases'
        text: |
          ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒæˆåŠŸï¼
          
          **ç‰ˆæœ¬**: ${{ needs.prepare-release.outputs.version }}
          **çŠ¶æ€**: ${{ needs.deploy-production.result == 'success' && 'âœ… å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ' || 'âš ï¸ ä»…åˆ›å»ºäº†Release' }}
          **å‘å¸ƒäºº**: ${{ github.actor }}
          
          ğŸ“¦ [æŸ¥çœ‹Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.version }})
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: ğŸ“§ é‚®ä»¶é€šçŸ¥
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ğŸ‰ ä¸šåŠ¡åˆ†ææŠ¥å‘Šç³»ç»Ÿ ${{ needs.prepare-release.outputs.version }} å‘å¸ƒæˆåŠŸ
        body: |
          æ–°ç‰ˆæœ¬ ${{ needs.prepare-release.outputs.version }} å·²æˆåŠŸå‘å¸ƒï¼
          
          å‘å¸ƒæ—¶é—´: $(date)
          å‘å¸ƒäºº: ${{ github.actor }}
          
          æ›´æ–°å†…å®¹:
          ${{ needs.prepare-release.outputs.changelog }}
          
          æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.version }}
        to: team@your-company.com
        from: noreply@your-company.com

  # æ›´æ–°æ–‡æ¡£
  update-docs:
    name: ğŸ“š æ›´æ–°æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“ æ›´æ–°ç‰ˆæœ¬æ–‡æ¡£
      run: |
        # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        sed -i "s/ç‰ˆæœ¬: v.*/ç‰ˆæœ¬: ${{ needs.prepare-release.outputs.version }}/g" README.md
        sed -i "s/Version: v.*/Version: ${{ needs.prepare-release.outputs.version }}/g" DOCKER_DEPLOYMENT_GUIDE.md
        
        # æ›´æ–°å‘å¸ƒæ—¥æœŸ
        sed -i "s/å‘å¸ƒæ—¶é—´: .*/å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d')/g" README.md

    - name: ğŸ’¾ æäº¤æ–‡æ¡£æ›´æ–°
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md DOCKER_DEPLOYMENT_GUIDE.md
        git commit -m "docs: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯åˆ° ${{ needs.prepare-release.outputs.version }}" || exit 0
        git push