# QWCoder Zsh Configuration
# Source this file in your ~/.zshrc

# Load QWCoder Environment
if [ -f "$QWCODER_HOME/config/environment.env" ]; then
    source "$QWCODER_HOME/config/environment.env"
fi

# Oh My Zsh Configuration
if [ -d "$HOME/.oh-my-zsh" ]; then
    export ZSH="$HOME/.oh-my-zsh"
    ZSH_THEME="agnoster"
    plugins=(git docker docker-compose node npm python pip aws azure kubectl helm)

    source $ZSH/oh-my-zsh.sh
else
    # Fallback prompt without Oh My Zsh
    export PS1='%F{green}%n@%m%f %F{yellow}%~%f %F{cyan}$(__git_ps1 "(%s)")%f %F{magenta}$ %f'
fi

# History Configuration
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTFILE="$HOME/.zsh_history"
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt SHARE_HISTORY
setopt EXTENDED_HISTORY
setopt INC_APPEND_HISTORY

# Auto-completion
autoload -Uz compinit
compinit
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# Directory Navigation
setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS

# Load Custom Functions
if [ -f "$QWCODER_HOME/scripts/functions.sh" ]; then
    source "$QWCODER_HOME/scripts/functions.sh"
fi

# Load Aliases
if [ -f "$QWCODER_HOME/config/aliases.sh" ]; then
    source "$QWCODER_HOME/config/aliases.sh"
fi

# Load Git Integration
if [ -f "$QWCODER_HOME/config/git-integration.sh" ]; then
    source "$QWCODER_HOME/config/git-integration.sh"
fi

# NVM (Node Version Manager)
if [ -f "$NVM_DIR/nvm.sh" ]; then
    source "$NVM_DIR/nvm.sh"
    autoload -U add-zsh-hook
    load-nvmrc() {
        local node_version="$(nvm version)"
        local nvmrc_path="$(nvm_find_nvmrc)"

        if [ -n "$nvmrc_path" ]; then
            local nvmrc_node_version=$(nvm version "$(cat "${nvmrc_path}")")

            if [ "$nvmrc_node_version" = "N/A" ]; then
                nvm install
            elif [ "$nvmrc_node_version" != "$node_version" ]; then
                nvm use
            fi
        elif [ "$node_version" != "$(nvm version default)" ]; then
            nvm use default
        fi
    }
    add-zsh-hook chpwd load-nvmrc
    load-nvmrc
fi

# Pyenv (Python Version Manager)
if command -v pyenv >/dev/null 2>&1; then
    eval "$(pyenv init --path)"
    eval "$(pyenv init -)"
fi

# SDKMAN (Java Version Manager)
if [ -f "$HOME/.sdkman/bin/sdkman-init.sh" ]; then
    source "$HOME/.sdkman/bin/sdkman-init.sh"
fi

# Welcome Message
cat << 'EOF'
╔════════════════════════════════════════════════════════════════╗
║                      Welcome to QWCoder                      ║
║                    Terminal Environment                      ║
╚════════════════════════════════════════════════════════════════╝
EOF
