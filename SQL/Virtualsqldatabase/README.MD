# SQL业务指标分析系统

## 项目概述
本系统是一个基于SQL的业务指标分析系统，用于多维度分析销售、库存和出货数据。系统支持按门店、商品、时间等多个维度进行数据分析，并提供丰富的统计指标。

## 系统架构
系统主要包含以下模块：
1. 基础数据模块
   - 农历数据管理
   - 日期查询工具
   - 商品信息管理

2. 销售分析模块
   - 日销量分析
   - 大类出货销售分析
   - 来客及单价分析
   - 促销活动分析

3. 库存分析模块
   - 门店库存分析
   - 总仓库库存分析
   - 库存周转分析

4. 出货分析模块
   - 出货达成分析
   - 去年同期对比
   - 大单品分析

## 功能特点
1. 多维度分析
   - 支持按门店、商品、时间等多维度分析
   - 提供灵活的筛选和统计功能
   - 支持自定义分析维度

2. 数据完整性
   - 自动处理数据编码问题
   - 确保数据一致性
   - 提供数据验证机制

3. 性能优化
   - 使用临时表优化查询性能
   - 合理使用索引
   - 优化SQL语句结构

## 优化进度表
| 文件编号 | 文件名称 | 优化状态 | 主要优化内容 |
|---------|---------|---------|------------|
| 01 | 农历出货.sql | ✅ 已优化 | 添加详细注释、计算同比增长率、优化性能 |
| 02 | 农历数据.sql | ✅ 已优化 | 添加详细注释、计算销售额同比增长率、优化性能 |
| 03 | 指标看板大类出货销售.sql | ✅ 已优化 | 添加详细注释、新增毛利率计算、增加去年同期对比、新增汇总分析 |
| 04 | 指标看板日销数据.sql | ✅ 已优化 | 添加详细注释、新增来客数和客单价统计、增加门店性能分析、添加索引优化 |
| 05 | 指标看板来客及单价.sql | ✅ 已优化 | 添加详细注释、新增参数配置、扩展多省份支持、增加周度趋势分析、添加对比分析 |
| 06 | 指标看板去年出货.sql | ✅ 已优化 | 添加详细注释、增加本年同期对比、新增汇总分析、添加同比增长率计算 |
| 07 | 指标看板出货达成.sql | ✅ 已优化 | 添加详细注释、新增预测达成率计算、增加环比增长趋势分析、提供目标对比功能 |
| 08 | 创建新表内容格式.sql | ✅ 已优化 | 添加详细注释、完善字段映射说明、增加使用指南、添加NOLOCK优化 |
| 09 | 抓大单品清单.sql | ✅ 已优化 | 添加详细注释、引入参数化设计、新增周转天数计算、优化查询性能、增加临时表清理 |
| 10 | 循环日销量表.sql | ✅ 已优化 | 添加详细注释、引入参数化设计、修复语法错误、添加错误处理、新增周转天数计算、增加临时表清理 |
| 11 | 促销流水.sql | ✅ 已优化 | 添加详细注释、引入参数化日期、修复语法错误、新增折扣率计算、增加大类维度分析、添加覆盖率统计 |
| 12 | 匹配促销.sql | ✅ 已优化 | 添加详细注释、修复字符编码问题、引入参数化设计、添加事务处理、增加多维度统计分析 |
| 13 | 专项.sql | ✅ 已优化 | 添加详细注释、修复字符编码问题、引入参数化设计、新增销售单价计算、增加按大类和小类多维度分析 |
| 14 | 出货.sql | ✅ 已优化 | 添加详细注释、修复字符编码问题、引入参数化设计、新增毛利率计算、增加按大类/事业部/商品备注多维度分析 |
| 15 | 更新商品表.sql | ✅ 已优化 | 添加详细注释、修复字符编码问题、引入参数化设计、新增覆盖率计算、增加门店详细分析报表 |
| 16 | 循环日销表V2.sql | ✅ 已优化 | 添加详细注释、优化循环逻辑、引入参数化设计、添加错误处理、新增周转天数计算、增加库存健康度评估 |
| 17-23 | 其他脚本 | ⏳ 待优化 | - |
| 24 | 去年出货+销售数据.sql | ✅ 已优化 | 基础数据表创建、销售数据循环插入、销售汇总计算 |
| 25 | 异常数据.sql | ✅ 已优化 | 异常数据检测、数据对比分析、数据验证逻辑 |
| 26 | 取日销售数据---到店型维度.sql | ✅ 已优化 | 按店型维度销售数据统计、同比分析、数据分类汇总 |
| 27 | 经营天数.sql | ✅ 已优化 | 经营天数统计、多维度分析、数据验证 |
| 28 | 总库存数据.sql | ✅ 已优化 | 总库存数据统计、库存分析、数据分类汇总 |
| 29 | 华中五省数据并追加.sql | ✅ 已优化 | 五省数据整合、数据追加功能、数据验证 |
| 30 | 出货-农夫.sql | ✅ 已优化 | 门店类型优化、事业部分类、出货数据分析 |
| 31 | 农夫山泉-东方树叶数据.sql | ✅ 已优化 | 商品分类逻辑、同比分析功能、数据验证逻辑 |
| **32** | **循环日销表V2.sql** | ✅ **已完成** | **修复编码问题、优化循环逻辑、添加错误处理、新增门店经营活跃度分析、完善库存周转天数计算** |

## 使用说明
1. 数据准备
   - 确保基础数据表已更新
   - 检查数据编码格式
   - 验证数据完整性

2. 执行顺序
   - 先执行基础数据脚本
   - 再执行分析脚本
   - 最后执行统计脚本

3. 注意事项
   - 注意数据编码格式
   - 定期备份重要数据
   - 及时更新基础数据

4. **特别说明：32-循环日销表V2.sql**
   - 脚本会自动检测数据库和表的存在性
   - 支持跨年度数据分析（2024年至今）
   - 自动处理湖南公司（hn）数据
   - 建议在业务低峰期运行以获得最佳性能

## 维护指南
1. 日常维护
   - 定期检查数据完整性
   - 更新基础数据
   - 优化查询性能

2. 数据备份
   - 定期备份重要数据
   - 保存历史版本
   - 建立恢复机制

## 重点功能：32-循环日销表V2.sql

### 功能描述
32-循环日销表V2.sql 是循环日销量表分析系统的核心模块，主要实现：
1. **动态循环获取多年份日销量数据**
2. **分析产品清单和销售数据**
3. **计算库存和销售指标**
4. **生成门店经营分析报表**
5. **统计门店经营天数和活跃度**

### 优化内容
- ✅ 添加详细注释和文档说明
- ✅ 修复中文编码问题
- ✅ 优化循环逻辑和性能
- ✅ 增加数据验证和统计分析
- ✅ 规范化临时表管理
- ✅ 完善门店分类逻辑
- ✅ 添加错误处理机制
- ✅ 增加库存周转天数计算
- ✅ 新增门店经营活跃度分析

### 代码结构
32-循环日销表V2.sql 采用模块化设计，包含以下12个主要部分：

#### 第一部分：参数设置和变量声明
```sql
-- 声明日期变量
DECLARE @SDD DATETIME,       -- 开始日期
        @EDD DATETIME,       -- 结束日期
        @CURDD DATETIME,     -- 当前日期
        @CY_YYYY VARCHAR(4), -- 当前年份
        @CY_DATE VARCHAR(8); -- 当前日期字符串

-- 设置分析时间范围（从2024年初到昨天）
SET @SDD = DATEADD(dd, DATEDIFF(dd, 0, CONVERT(datetime, '2024-1-1')), 0);
SET @EDD = DATEADD(dd, DATEDIFF(dd, 0, GETDATE()-1), 0);
```

#### 第二部分：创建基础临时表
```sql
-- 创建门店日销量数据临时表
CREATE TABLE #moutdrpt (
    astore VARCHAR(10),     -- 门店编码
    adate DATETIME,         -- 销售日期
    bgdgid VARCHAR(10),     -- 商品编码
    dq1 MONEY,             -- 期初数量
    dq5 MONEY,             -- 期末数量
    dt1 MONEY,             -- 期初金额
    dt5 MONEY              -- 期末金额
);
```

#### 第三部分：循环获取多年份销售数据
```sql
-- 循环处理每一天的数据（注意：湖南数据需要特殊处理）
WHILE @SDD < @CURDD
BEGIN
    -- 动态构建SQL语句，从对应年份和日期的表中获取数据
    SET @SQL1 = '
    IF EXISTS (SELECT 1 FROM sys.databases WHERE name = ''odsdbfq_' + @CY_YYYY + ''')
    BEGIN
        IF EXISTS (SELECT 1 FROM odsdbfq_' + @CY_YYYY + '.INFORMATION_SCHEMA.TABLES 
                  WHERE TABLE_NAME = ''moutdrpt_' + @CY_DATE + ''')
        BEGIN
            INSERT INTO #moutdrpt
            SELECT astore, adate, bgdgid, dq1, dq5, dt1, dt5 
            FROM odsdbfq_' + @CY_YYYY + '.dbo.moutdrpt_' + @CY_DATE + ' WITH (NOLOCK)
            WHERE companycode = ''hn'';
        END
    END';
    EXEC (@SQL1);
END;
```

#### 第四至十一部分：数据分析和处理
- **第四部分**：获取产品清单数据
- **第五部分**：销售数据分析处理
- **第六部分**：匹配完整销售数据信息
- **第七部分**：库存数据分析
- **第八部分**：数据汇总统计
- **第九部分**：门店信息处理
- **第十部分**：生成最终分析报表
- **第十一部分**：门店经营天数分析

#### 第十二部分：清理临时表和错误处理
```sql
-- 错误处理机制
BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);
    SELECT @ErrorMessage = ERROR_MESSAGE();
    PRINT '执行过程中发生错误: ' + @ErrorMessage;
    -- 清理临时表
    DROP TABLE IF EXISTS #moutdrpt;
    -- ... 其他临时表清理
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
END CATCH;
```

### 主要功能特性

#### 1. 智能数据循环获取
- 动态检测数据库和表的存在性
- 按日期循环获取多年份数据
- 自动处理数据缺失情况
- 支持跨年度数据分析

#### 2. 多维度销售分析
- 按门店、商品、时间维度分析
- 支持指定产品清单过滤
- 提供特殊类别（0705）分析
- 计算销售数量和金额

#### 3. 库存健康度分析
- 库存数量和金额统计
- 库存周转天数计算
- 滞动店和缺货店识别
- 库存占比分析

#### 4. 门店经营评估
- 经营天数统计
- 经营活跃度评估（高/中/低活跃）
- 日均销售额计算
- 门店性能排名

#### 5. 数据质量保障
- 完整的错误处理机制
- 临时表自动清理
- 数据验证和统计
- 执行进度跟踪

### 输出报表

#### 1. 门店销售和库存综合分析报表
包含字段：
- 事业部、开发区、督导、指导员
- 门店编号、店名、店型
- 商品信息、销售数量、销售金额
- 库存数量、库存金额
- 是否开货、滞动店标识、缺货标识
- 库存周转天数、销售占比

#### 2. 门店经营分析报表
包含指标：
- 门店数量、总经营天数、平均经营天数
- 总销售额、平均日销额
- 高活跃门店数、高活跃门店占比
- 经营活跃度分布

### 性能优化特性
1. **索引优化**：合理使用NOLOCK提高查询速度
2. **内存管理**：及时清理临时表释放内存
3. **批处理**：按日期批量处理数据
4. **错误处理**：完善的异常处理机制
5. **进度跟踪**：实时输出处理进度信息

## 更新日志

### 2024-03-21 - 重大更新：32号文件全面优化
1. **完成循环日销量表/32-循环日销表V2.sql的全面优化**：
   - ✅ 修复了中文编码问题，所有中文字段正确显示
   - ✅ 优化了循环逻辑，增加了数据库和表存在性检查
   - ✅ 添加了完整的错误处理机制和进度跟踪
   - ✅ 规范化了所有临时表的创建和清理
   - ✅ 新增库存周转天数和门店经营活跃度分析
   - ✅ 完善了门店分类逻辑和事业部更新机制
   - ✅ 添加了详细的模块化注释和文档说明

2. **32号文件主要技术改进**：
   - **智能数据循环获取**：动态检测数据库和表的存在性，支持跨年度数据分析
   - **多维度销售分析**：按门店、商品、时间维度分析，支持特殊类别过滤
   - **库存健康度分析**：库存周转天数计算、滞动店和缺货店识别
   - **门店经营评估**：经营活跃度评估（高/中/低活跃）、日均销售额计算
   - **数据质量保障**：完整的错误处理机制、临时表自动清理、执行进度跟踪

3. **文档完善**：
   - 合并了主项目和循环日销量表模块的README文档
   - 添加了详细的功能描述和代码结构说明
   - 提供了完整的使用说明和注意事项
   - 补充了性能优化和错误处理相关内容

### 2024-03-21 - 其他优化
1. 优化了以下文件的编码和结构：
   - 17-日期查询.sql：修复编码问题，优化日期查询函数
   - 18-门店库存数据.sql：完善门店库存分析功能
   - 19-总仓库库存.sql：优化总仓库库存分析逻辑

2. 主要改进：
   - 修复了中文编码问题
   - 优化了SQL语句结构
   - 添加了详细的注释说明
   - 改进了代码可读性

## 详细功能说明

### 01-农历出货.sql

#### 实现进度
- [x] 完成农历出货对比分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程、临时表使用和最终输出
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于对比当前年度与去年农历同期的出货净额，便于业务分析和同比趋势判断。

#### 代码结构
1. **定义日期变量**：设置本期与去年同期的起止日期。
2. **输出参数**：便于调试和确认参数设置。
3. **计算本期每日净出货额**：过滤特定类别、公司和仓库，结果存入临时表`#cy`。
4. **计算去年同期每日净出货额并日期平移**：将去年日期平移384天，与本期对齐，结果存入临时表`#ly`。
5. **合并本期与去年同期数据**：通过FULL JOIN对比本期与去年同期每日出货净额。
6. **可选清理临时表**：如需多次运行可清理临时表。

#### 主要SQL片段示例
```sql
-- 定义日期变量
DECLARE @sdate DATE = '2024-01-01';
DECLARE @edate DATE = '2024-12-31';
DECLARE @lysdate DATE = '2022-01-01';
DECLARE @lyedate DATE = '2024-12-31';

-- 计算本期每日净出货额
SELECT CONVERT(VARCHAR(20), adate, 112) AS 出货日期, SUM(goods_out_money - goods_back_money) AS 净出货额
INTO #cy
FROM odsdbfq_result.dbo.m_store_out_sort WITH (NOLOCK)
WHERE adate >= @sdate AND adate <= @edate ...
GROUP BY CONVERT(VARCHAR(20), adate, 112);
```

---

### 02-农历数据.sql

#### 实现进度
- [x] 完成农历销售数据对比分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程、临时表使用和最终输出
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于对比当前年度与去年农历同期的销售数据（如天数、销售额），便于业务分析和同比趋势判断。

---

### 03-指标看板大类出货销售.sql

#### 实现进度
- [x] 完成多省份大类商品出货销售分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程、临时表使用和最终输出
- [x] 扩展了分析功能，新增了去年同期分析和汇总对比
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于统计多省份大类商品的出货额与毛利额，支持本期累计、上周、去年同期多维度对比，便于分析商品大类的销售趋势和毛利情况。

---

### 04-指标看板日销数据.sql

#### 实现进度
- [x] 完成多省份门店日销售数据分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程、临时表使用和最终输出
- [x] 扩展了分析功能，新增多维度指标和对比分析
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于统计多省份门店的日销售数据，按门店类型分组，支持本期、上周、去年同期多维度对比，便于分析销售趋势和门店绩效。

---

### 05-指标看板来客及单价.sql

#### 实现进度
- [x] 完成门店来客及客单价分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程和最终输出
- [x] 扩展了分析功能，新增多维度指标和时间维度分析
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于统计门店日均销售额、日均来客数及客单价，支持日期范围参数配置，适用于客流分析和门店经营评估。

---

### 06-指标看板去年出货.sql

#### 实现进度
- [x] 完成去年同期出货分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程和最终输出
- [x] 扩展了分析功能，新增本年同期对比和同比增长率分析
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于统计去年同期每日各品类出货额与毛利额，支持灵活的日期参数配置，便于与本期数据进行对比分析。

---

### 07-指标看板出货达成.sql

#### 实现进度
- [x] 完成本期出货达成分析SQL脚本的优化与详细注释
- [x] 明确了参数定义、数据处理流程和最终输出
- [x] 扩展了分析功能，新增预测达成和环比增长率分析
- [x] 代码结构和逻辑已整理并注释

#### 功能说明
本脚本用于统计本期出货达成情况，并计算剩余天数和预测达成率，支持品类维度分析和目标对比。

---

### 08-创建新表内容格式.sql

#### 实现进度
- [x] 完成创建新表内容格式示例SQL脚本的优化与详细注释
- [x] 明确了数据导入流程和字段映射关系
- [x] 代码结构更加清晰，便于理解和修改

#### 功能说明
本脚本提供了数据从上传表到目标表的映射与转换标准示例，可用于批量数据导入操作。

---

### 09-抓大单品清单.sql

#### 实现进度
- [x] 完成大单品多维度分析SQL脚本的优化与详细注释
- [x] 引入参数化设计，使脚本更加灵活可配置
- [x] 新增周转天数计算并增强异常情况分析
- [x] 完善临时表清理，优化资源使用

#### 功能说明
本脚本用于抓取大单品清单及其销售、库存、门店等多维度数据，支持按时间、区域、品类等多维度分析。

---

### 10-循环日销量表.sql

#### 实现进度
- [x] 完成循环门店销售分析SQL脚本的优化与详细注释
- [x] 优化循环逻辑，提高数据处理的稳定性和效率
- [x] 修复多处语法错误，完善错误处理机制
- [x] 新增多种业务指标计算，提升分析价值

#### 功能说明
本脚本通过循环处理每日销售数据，统计门店销售与库存情况，支持按门店、商品、备注等多维度分析。

---

### 11-促销流水.sql

#### 实现进度
- [x] 完成促销活动多维度分析SQL脚本的优化与详细注释
- [x] 引入参数化日期设计，灵活配置分析时间范围
- [x] 增加折扣率计算和覆盖率分析等多个业务指标
- [x] 新增大类维度分析，提供更全面的促销效果评估

#### 功能说明
本脚本用于分析促销活动数据，支持按日期、门店、商品等多维度分析，帮助评估促销效果。

---

### 12-匹配促销.sql

#### 实现进度
- [x] 完成促销数据匹配与分析SQL脚本的优化与详细注释
- [x] 修复了字符编码问题，确保所有中文字符正确显示
- [x] 引入参数化设计，增加事务处理确保数据操作安全性
- [x] 新增多维度统计分析，提供更全面的促销效果评估

#### 功能说明
本脚本用于匹配促销数据并进行多维度分析，支持按日期、门店、商品等维度进行统计。

---

### 13-专项.sql

#### 实现进度
- [x] 完成专项商品销售分析SQL脚本的优化与详细注释
- [x] 修复了字符编码问题，确保所有中文字符正确显示
- [x] 引入参数化设计，增加事务处理确保数据操作安全性
- [x] 新增多维度统计分析，提供更全面的专项商品销售评估

#### 功能说明
本脚本用于分析专项商品销售数据，支持按日期、门店、商品等多维度分析。

---

### 14-出货.sql

#### 实现进度
- [x] 完成出货数据分析SQL脚本的优化与详细注释
- [x] 修复了字符编码问题，确保所有中文字符正确显示
- [x] 引入参数化设计，增加事务处理确保数据操作安全性
- [x] 新增多维度统计分析，提供更全面的出货数据评估

#### 功能说明
本脚本用于分析出货数据，支持按日期、门店、商品等多维度分析。

---

### 15-更新商品表.sql

#### 实现进度
- [x] 完成特定商品销售分析SQL脚本的优化与详细注释
- [x] 修复了字符编码问题，确保所有中文字符正确显示
- [x] 引入参数化设计，提高脚本灵活性与可维护性
- [x] 新增多维度统计分析功能，提供更全面的销售评估

#### 功能说明
本脚本用于分析特定商品（脉动和东方树叶）在各事业部的销售情况。

---

### 16-循环日销表V2.sql

#### 实现进度
- [x] 完成循环门店销售分析SQL脚本的优化与详细注释
- [x] 优化循环逻辑，提高数据处理的稳定性和效率
- [x] 修复多处语法错误，完善错误处理机制
- [x] 新增多种业务指标计算，提升分析价值

#### 功能说明
本脚本是循环日销量表的增强版本，通过循环处理每日销售数据，统计门店销售与库存情况。

## 注意事项
1. 代码中的'hn'表示湖南公司代码
2. 确保临时表空间充足
3. 注意数据量大小，可能需要适当调整查询性能
4. 定期清理临时表
5. 注意数据备份
6. **32号文件特别注意**：
   - 脚本运行时间较长，请耐心等待
   - 自动包含错误处理，执行失败会自动清理
   - 输出多个分析报表，请根据需要选择使用

## 联系方式
如有问题请联系系统管理员。